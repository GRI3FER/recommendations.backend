const nodemailer = require('nodemailer');

let transporter;

// Create transporter lazily (better for serverless)
function getTransporter() {
    if (!transporter) {
        if (!process.env.EMAIL_USER || !process.env.EMAIL_PASSWORD) {
            throw new Error('Missing EMAIL_USER or EMAIL_PASSWORD env variables');
        }

        transporter = nodemailer.createTransport({
            host: 'smtp.gmail.com',
            port: 587,
            secure: false,
            auth: {
                user: process.env.EMAIL_USER,
                pass: process.env.EMAIL_PASSWORD
            }
        });
    }

    return transporter;
}

// Basic HTML escape to prevent injection
function escapeHtml(str) {
    return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

async function sendAdminNotification(endorsement) {
    try {
        const transporter = getTransporter();

        const mailOptions = {
            from: `"Portfolio Bot" <${process.env.EMAIL_USER}>`,
            to: process.env.ADMIN_EMAIL,
            subject: `New Endorsement from ${escapeHtml(endorsement.name)}`,
            html: `
                <h2>New Endorsement Submission</h2>
                <p><strong>From:</strong> ${escapeHtml(endorsement.name)}</p>
                <p><strong>Email:</strong> ${escapeHtml(endorsement.email)}</p>
                <p><strong>Role:</strong> ${escapeHtml(endorsement.role)}</p>
                <p><strong>Relationship:</strong> ${escapeHtml(endorsement.relationship)}</p>
                <p><strong>LinkedIn:</strong> 
                    <a href="${escapeHtml(endorsement.linkedin)}">
                        ${escapeHtml(endorsement.linkedin)}
                    </a>
                </p>
                <br>
                <p><strong>Endorsement:</strong></p>
                <blockquote style="background:#f5f5f5;padding:15px;border-left:4px solid #667eea;">
                    ${escapeHtml(endorsement.endorsement)}
                </blockquote>
                <br>
                <p><strong>Submitted:</strong> 
                    ${new Date(endorsement.submittedDate).toLocaleString()}
                </p>
                <br>
                <p>
                    <a href="${process.env.ADMIN_URL}/endorsements-admin.html"
                       style="background:#667eea;color:white;padding:10px 20px;
                              text-decoration:none;border-radius:5px;">
                       Review in Admin Panel
                    </a>
                </p>
            `
        };

        await transporter.sendMail(mailOptions);
        console.log('✅ Admin notification sent');

    } catch (error) {
        console.error('❌ Error sending admin notification:', error);
    }
}

async function sendApprovalNotification(endorsement) {
    try {
        const transporter = getTransporter();

        const mailOptions = {
            from: `"Portfolio Team" <${process.env.EMAIL_USER}>`,
            to: endorsement.email,
            subject: 'Your Endorsement Has Been Approved!',
            html: `
                <h2>Thank You for Your Endorsement!</h2>
                <p>Hi ${escapeHtml(endorsement.name)},</p>
                <p>Your endorsement has been approved and is now live!</p>
                <br>
                <p><strong>Your endorsement:</strong></p>
                <blockquote style="background:#f5f5f5;padding:15px;border-left:4px solid #667eea;">
                    "${escapeHtml(endorsement.endorsement)}"
                </blockquote>
                <br>
                <p>Thank you for taking the time to share your experience.</p>
                <p>Best regards,<br>Your Portfolio Team</p>
            `
        };

        await transporter.sendMail(mailOptions);
        console.log('✅ Approval notification sent');

    } catch (error) {
        console.error('❌ Error sending approval notification:', error);
    }
}

module.exports = { sendAdminNotification, sendApprovalNotification };
